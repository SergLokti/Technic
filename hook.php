<?php
/**
 * =====================================================
 * –•–£–ö–ò –ü–õ–ê–ì–ò–ù–ê TECHNIC
 * =====================================================
 * 
 * –°–û–î–ï–†–ñ–ò–¢:
 * - plugin_technic_install()      ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ë–î
 * - plugin_technic_uninstall()    ‚Üí –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ë–î
 * - cron_plugin_technic_cron()    ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
 * - plugin_technic_cronInfo()     ‚Üí –û–ø–∏—Å–∞–Ω–∏–µ cron –∑–∞–¥–∞—á–∏
 * 
 * –¢–ê–ë–õ–ò–¶–´ –ë–î:
 * - glpi_plugin_technic_history   ‚Üí –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π (–¥–ª—è approve_item_history)
 * 
 * –ù–ê–°–¢–†–û–ô–ö–ò:
 * - –•—Ä–∞–Ω—è—Ç—Å—è –≤ inc/config.php (PHP —Ñ–∞–π–ª, –Ω–µ –ë–î)
 * 
 * –õ–û–ì–ò:
 * - –ü–∏—à—É—Ç—Å—è –≤ glpi_itilfollowups (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç–∏–∫–µ—Ç—É)
 * =====================================================
 */

if (!defined('GLPI_ROOT')) {
   die("Sorry. You can't access this file directly");
}

/**
 * =====================================================
 * –£–°–¢–ê–ù–û–í–ö–ê –ü–õ–ê–ì–ò–ù–ê
 * =====================================================
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "Install" –≤ Setup ‚Üí Plugins
 * 
 * @param Migration $migration –û–±—ä–µ–∫—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
 * @return bool true=—É—Å–ø–µ—Ö, false=–æ—à–∏–±–∫–∞
 */
function plugin_technic_install(Migration $migration) {
   global $DB;
   
   // ========================================
   // –¢–ê–ë–õ–ò–¶–ê: –ò–°–¢–û–†–ò–Ø –î–ï–ô–°–¢–í–ò–ô
   // ========================================
   // –•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π –ø–ª–∞–≥–∏–Ω–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ approve_item_history()
   // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: "–í—ã–¥–∞–≤–∞–ª—Å—è –ª–∏ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   // –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É —Ä–µ—Å—É—Ä—Å—É –≤ –ø—Ä–æ—à–ª—ã—Ö —Ç–∏–∫–µ—Ç–∞—Ö?"
   
   $table = 'glpi_plugin_technic_history';
   
   if (!$DB->tableExists($table)) {
      
      $query = "CREATE TABLE `{$table}` (
         
         -- –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
         `id` int(11) NOT NULL AUTO_INCREMENT,
         
         -- –ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ
         `date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
         
         -- –°–≤—è–∑—å —Å —Ç–∏–∫–µ—Ç–æ–º (FK ‚Üí glpi_tickets.id)
         `tickets_id` int(11) NOT NULL
            COMMENT 'ID —Ç–∏–∫–µ—Ç–∞',
         
         -- –°–≤—è–∑—å —Å –∑–∞–¥–∞—á–µ–π (FK ‚Üí glpi_tickettasks.id)
         `task_id` int(11) NOT NULL
            COMMENT 'ID –∑–∞–¥–∞—á–∏ –≤ —Ç–∏–∫–µ—Ç–µ',
         
         -- –¢–∏–ø –∑–∞–¥–∞—á–∏ (tasktemplates_id)
         `task_type_id` int(11) NOT NULL
            COMMENT 'Template ID –∑–∞–¥–∞—á–∏',
         
         -- –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è
         `action` varchar(50) DEFAULT NULL
            COMMENT '–î–µ–π—Å—Ç–≤–∏–µ: add, delete, export',
         
         -- DN –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ–º—É –≤—ã–¥–∞–ª–∏/—É–±—Ä–∞–ª–∏ –¥–æ—Å—Ç—É–ø)
         `users_dn` varchar(500) DEFAULT NULL
            COMMENT 'Distinguished Name –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ AD',
         
         -- DN –≥—Ä—É–ø–ø—ã –∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
         `group_dn` varchar(500) DEFAULT NULL
            COMMENT 'Distinguished Name –≥—Ä—É–ø–ø—ã AD –∏–ª–∏ SCCM –∫–æ–ª–ª–µ–∫—Ü–∏–∏',
         
         -- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
         PRIMARY KEY (`id`),
         KEY `tickets_id` (`tickets_id`),
         KEY `task_id` (`task_id`),
         KEY `users_dn` (`users_dn`(255)),
         KEY `group_dn` (`group_dn`(255)),
         KEY `date` (`date`)
         
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
        COMMENT='–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π Technic –¥–ª—è approve_item_history()';";
      
      $DB->query($query) or die("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: " . $DB->error());
      
      $migration->displayMessage("‚úÖ –¢–∞–±–ª–∏—Ü–∞ {$table} —Å–æ–∑–¥–∞–Ω–∞");
   }
   
   
   // ========================================
   // –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
   // ========================================
   // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª inc/config.php —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   
   $config_file = __DIR__ . '/inc/config.php';
   
   if (!file_exists($config_file)) {
      $migration->displayWarning(
         "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª inc/config.php<br>" .
         "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω: <code>cp inc/config.php.example inc/config.php</code><br>" .
         "–ó–∞—Ç–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ LDAP/SCCM –≤ inc/config.php"
      );
   } else {
      $migration->displayMessage("‚úÖ –§–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–π–¥–µ–Ω: inc/config.php");
   }
   
   
   // ========================================
   // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø CRON –ó–ê–î–ê–ß–ò
   // ========================================
   // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ GLPI: Setup ‚Üí Automatic actions
   
   CronTask::register(
      'PluginTechnicCron',           // –ö–ª–∞—Å—Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
      'technic',                      // –ò–º—è –∑–∞–¥–∞—á–∏
      5 * MINUTE_TIMESTAMP,           // –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
      [
         'comment' => 'Technic: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –ø–æ –¥–æ—Å—Ç—É–ø–∞–º (LDAP/SCCM/PowerShell)',
         'mode'    => CronTask::MODE_EXTERNAL,  // –í–Ω–µ—à–Ω–∏–π cron (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é)
         'state'   => CronTask::STATE_WAITING   // –ê–∫—Ç–∏–≤–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      ]
   );
   
   $migration->displayMessage("‚úÖ Cron –∑–∞–¥–∞—á–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ (–∏–Ω—Ç–µ—Ä–≤–∞–ª: 5 –º–∏–Ω—É—Ç)");
   
   
   // ========================================
   // –§–ò–ù–ê–õ
   // ========================================
   
   $migration->displayMessage("<br>üéâ <b>–ü–ª–∞–≥–∏–Ω Technic —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!</b><br>");
   $migration->displayMessage("–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:");
   $migration->displayMessage("1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ inc/config.php (LDAP/SCCM –ø–∞—Ä–æ–ª–∏)");
   $migration->displayMessage("2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ cron: Setup ‚Üí Automatic actions ‚Üí Technic ‚Üí Execute");
   
   return true;
}


/**
 * =====================================================
 * –£–î–ê–õ–ï–ù–ò–ï –ü–õ–ê–ì–ò–ù–ê
 * =====================================================
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "Uninstall" –≤ Setup ‚Üí Plugins
 * ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Å –∏—Å—Ç–æ—Ä–∏–µ–π!
 * 
 * @return bool true=—É—Å–ø–µ—Ö
 */
function plugin_technic_uninstall() {
   global $DB;
   
   // ========================================
   // –£–î–ê–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´
   // ========================================
   
   $table = 'glpi_plugin_technic_history';
   
   if ($DB->tableExists($table)) {
      $DB->query("DROP TABLE `{$table}`");
      echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ {$table} —É–¥–∞–ª–µ–Ω–∞<br>";
   }
   
   
   // ========================================
   // –£–î–ê–õ–ï–ù–ò–ï CRON –ó–ê–î–ê–ß–ò
   // ========================================
   
   $cron = new CronTask();
   if ($cron->getFromDBbyName('PluginTechnicCron', 'technic')) {
      $cron->delete(['id' => $cron->fields['id']]);
      echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞<br>";
   }
   
   
   // ========================================
   // –ü–†–ò–ú–ï–ß–ê–ù–ò–ï
   // ========================================
   
   echo "<br>‚ÑπÔ∏è –§–∞–π–ª inc/config.php –ù–ï —É–¥–∞–ª–µ–Ω (—Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–æ–ª–∏)<br>";
   echo "–ï—Å–ª–∏ –Ω—É–∂–Ω–æ - —É–¥–∞–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é<br>";
   echo "<br>üóëÔ∏è –ü–ª–∞–≥–∏–Ω Technic —É–¥–∞–ª–µ–Ω<br>";
   
   return true;
}


/**
 * =====================================================
 * CRON –û–ë–†–ê–ë–û–¢–ß–ò–ö
 * =====================================================
 * –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
 * –∏–ª–∏ –≤—Ä—É—á–Ω—É—é: Setup ‚Üí Automatic actions ‚Üí Technic ‚Üí Execute
 * 
 * –ê–õ–ì–û–†–ò–¢–ú:
 * 1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ inc/config.php
 * 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á
 * 3. –î–∏—Å–ø–µ—Ç—á–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏
 * 4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
 * 
 * @param CronTask $task –û–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏ GLPI
 * @return int 1=—É—Å–ø–µ—Ö, 0=–æ—à–∏–±–∫–∞, -1=–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
 */
function cron_plugin_technic_cron($task) {
   
   // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
   $task->log("üöÄ Technic: –∑–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á");
   
   try {
      
      // ========================================
      // –®–ê–ì 1: –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
      // ========================================
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ PHP —Ñ–∞–π–ª–∞ (–Ω–µ –∏–∑ –ë–î)
      
      $config_file = __DIR__ . '/inc/config.php';
      
      if (!file_exists($config_file)) {
         $task->log("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª inc/config.php");
         $task->log("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω: cp inc/config.php.example inc/config.php");
         return 0; // 0 = –æ—à–∏–±–∫–∞
      }
      
      $config = require $config_file;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      if (empty($config['ldap_host']) || empty($config['auth_user'])) {
         $task->log("‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ inc/config.php");
         return 0;
      }
      
      
      // ========================================
      // –®–ê–ì 2: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ò–°–ü–ï–¢–ß–ï–†–ê
      // ========================================
      // –î–∏—Å–ø–µ—Ç—á–µ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö handlers
      
      $dispatcher = new PluginTechnicTaskDispatcher($config);
      
      
      // ========================================
      // –®–ê–ì 3: –ó–ê–ü–£–°–ö –û–ë–†–ê–ë–û–¢–ö–ò
      // ========================================
      // –ú–µ—Ç–æ–¥ run() –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–º –∑–∞–¥–∞—á–∞–º
      
      $stats = $dispatcher->run();
      
      
      // ========================================
      // –®–ê–ì 4: –°–¢–ê–¢–ò–°–¢–ò–ö–ê
      // ========================================
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
      
      $task->addVolume($stats['processed']); // –°—á–µ—Ç—á–∏–∫ –¥–ª—è GLPI
      
      $task->log(sprintf(
         "‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: %d | –£—Å–ø–µ—à–Ω–æ: %d | –û—à–∏–±–æ–∫: %d | –ü—Ä–æ–ø—É—â–µ–Ω–æ: %d",
         $stats['processed'],
         $stats['success'],
         $stats['errors'],
         $stats['skipped']
      ));
      
      
      // ========================================
      // –®–ê–ì 5: –í–û–ó–í–†–ê–¢ –†–ï–ó–£–õ–¨–¢–ê–¢–ê
      // ========================================
      
      return 1; // 1 = —É—Å–ø–µ—Ö, cron –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
      
   } catch (Exception $e) {
      
      // ========================================
      // –û–ë–†–ê–ë–û–¢–ö–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö
      // ========================================
      
      $task->log("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: " . $e->getMessage());
      
      // –õ–æ–≥–∏—Ä—É–µ–º –≤ —Ñ–∞–π–ª PHP (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      error_log(
         "Technic cron error: " . $e->getMessage() . "\n" .
         $e->getTraceAsString()
      );
      
      return 0; // 0 = –æ—à–∏–±–∫–∞, cron –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
   }
}


/**
 * –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û CRON –¢–ê–°–ö–ï
 * ------------------------
 * –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è Setup ‚Üí Automatic actions
 * 
 * @param string $name –ò–º—è –∑–∞–¥–∞—á–∏
 * @return array –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
 */
function plugin_technic_cronInfo($name) {
   return [
      'description' => 'Technic: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –ø–æ –¥–æ—Å—Ç—É–ø–∞–º (LDAP/SCCM/PowerShell)',
      'parameter'   => $name
   ];
}
?>